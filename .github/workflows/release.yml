name: Release

on:
  push:
    branches: [master]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Changeset-driven: creates/updates a "Version Packages" PR
  changeset:
    name: Changeset Version
    if: github.ref == 'refs/heads/master' && !startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
      hasChangesets: ${{ steps.changesets.outputs.hasChangesets }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.8"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          title: "chore: version packages"
          commit: "chore: version packages"
          version: bun changeset version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Determine if we should build release artifacts
  should-release:
    name: Check Release Trigger
    runs-on: ubuntu-latest
    needs: [changeset]
    if: always()
    outputs:
      release: ${{ steps.check.outputs.release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if release should proceed
        id: check
        run: |
          # Release if: tag push OR changeset published packages
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ needs.changeset.outputs.published }}" == "true" ]]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(node -p "require('./apps/desktop/package.json').version")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  # Build and publish release artifacts
  release-build:
    name: Release Build (${{ matrix.os }})
    needs: [should-release]
    if: needs.should-release.outputs.release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.8"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build electron-vite
        run: bun run build
        working-directory: apps/desktop

      - name: Package & Publish Electron app
        run: bun run package:${{ matrix.platform }} -- --publish always
        working-directory: apps/desktop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Skip code signing for now (configure secrets when ready)
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          # macOS notarization (uncomment when configured)
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # CSC_LINK: ${{ secrets.MAC_CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CSC_KEY_PASSWORD }}

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: |
            apps/desktop/release/*.AppImage
            apps/desktop/release/*.deb
            apps/desktop/release/*.rpm
            apps/desktop/release/*.yml
          retention-days: 90

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
            apps/desktop/release/*.yml
          retention-days: 90

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'win'
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            apps/desktop/release/*.exe
            apps/desktop/release/*.yml
          retention-days: 90

  # Create GitHub Release (for tag-based releases)
  create-release:
    name: Create GitHub Release
    needs: [should-release, release-build]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Codedeck ${{ needs.should-release.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
